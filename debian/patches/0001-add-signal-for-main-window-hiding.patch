From e37b9f2714517b3260384c36669e7759cc815f7f Mon Sep 17 00:00:00 2001
From: Chris Talbot <chris@talbothome.com>
Date: Tue, 6 Feb 2024 20:29:40 -0700
Subject: [PATCH 1/3] application: add signal for main window hiding

---
 src/calls-application.c | 29 ++++++++++++++++++++++++++++-
 1 file changed, 28 insertions(+), 1 deletion(-)

diff --git a/src/calls-application.c b/src/calls-application.c
index 3c6ffe214..302e661d6 100644
--- a/src/calls-application.c
+++ b/src/calls-application.c
@@ -80,6 +80,12 @@ struct _CallsApplication {
 
 G_DEFINE_TYPE (CallsApplication, calls_application, GTK_TYPE_APPLICATION);
 
+enum {
+  SIGNAL_MAIN_WINDOW_CLOSED,
+  N_SIGNALS
+};
+
+static guint signals[N_SIGNALS];
 
 static void start_proper (CallsApplication *self);
 
@@ -636,6 +642,16 @@ on_db_done (CallsRecordStore *store,
     g_warning ("Database did not get opened");
 }
 
+static gboolean
+on_main_window_hidden (GtkWidget *widget,
+                       gpointer data)
+{
+  CallsApplication *self = CALLS_APPLICATION (g_application_get_default ());
+
+  g_signal_emit_by_name (self, "main-window-closed", 0);
+
+  return FALSE;
+}
 
 static void
 start_proper (CallsApplication *self)
@@ -683,8 +699,12 @@ start_proper (CallsApplication *self)
                            G_CALLBACK (notify_window_visible_cb),
                            self,
                            G_CONNECT_AFTER);
-}
 
+  g_signal_connect (G_OBJECT (self->main_window),
+                    "hide",
+                    G_CALLBACK (on_main_window_hidden),
+                    NULL);
+}
 
 static void
 activate (GApplication *application)
@@ -786,6 +806,13 @@ calls_application_class_init (CallsApplicationClass *klass)
   GApplicationClass *application_class = G_APPLICATION_CLASS (klass);
   GObjectClass *object_class = G_OBJECT_CLASS (klass);
 
+  signals [SIGNAL_MAIN_WINDOW_CLOSED] =
+    g_signal_new ("main-window-closed",
+                  G_TYPE_FROM_CLASS (klass),
+                  G_SIGNAL_RUN_LAST,
+                  0, NULL, NULL, NULL,
+                  G_TYPE_NONE, 0);
+
   object_class->finalize = finalize;
 
   application_class->handle_local_options = calls_application_handle_local_options;
-- 
GitLab


From 4030d32ecc025c202b13b03353cd66ce94b007a3 Mon Sep 17 00:00:00 2001
From: Chris Talbot <chris@talbothome.com>
Date: Tue, 6 Feb 2024 20:52:32 -0700
Subject: [PATCH 2/3] contacts-box: clear entry if window is closed

---
 src/calls-contacts-box.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/src/calls-contacts-box.c b/src/calls-contacts-box.c
index 64626eb31..968cb6025 100644
--- a/src/calls-contacts-box.c
+++ b/src/calls-contacts-box.c
@@ -160,6 +160,12 @@ contacts_sort_func (CallsContactsRow *a,
   return fav_a ? -1 : 1;
 }
 
+static void
+on_main_window_closed (CallsContactsBox *self)
+{
+  gtk_entry_set_text (GTK_ENTRY (self->search_entry), "");
+}
+
 
 static void
 calls_contacts_box_class_init (CallsContactsBoxClass *klass)
@@ -226,6 +232,11 @@ calls_contacts_box_init (CallsContactsBox *self)
                             G_CALLBACK (search_changed_cb),
                             self);
 
+  g_signal_connect_swapped (g_application_get_default (),
+                            "main-window-closed",
+                            G_CALLBACK (on_main_window_closed),
+                            self);
+
   if (!gee_collection_get_is_empty (individuals))
     calls_contacts_provider_consume_iter_on_idle (gee_iterable_iterator (GEE_ITERABLE (individuals)),
                                                   (IdleCallback) contacts_provider_added,
-- 
GitLab


From d97889ea341f0cff1132638713ee6613592b4d43 Mon Sep 17 00:00:00 2001
From: Chris Talbot <chris@talbothome.com>
Date: Tue, 6 Feb 2024 20:52:52 -0700
Subject: [PATCH 3/3] new-call-box: clear number entry when windows is closed

---
 src/calls-new-call-box.c | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/src/calls-new-call-box.c b/src/calls-new-call-box.c
index ea12cccdc..a15cd3860 100644
--- a/src/calls-new-call-box.c
+++ b/src/calls-new-call-box.c
@@ -318,6 +318,15 @@ calls_new_call_box_get_property (GObject    *object,
   }
 }
 
+static void
+on_main_window_closed (CallsNewCallBox *self)
+{
+  g_object_set (self->dialpad,
+                "number",
+                "",
+                NULL);
+}
+
 static void
 calls_new_call_box_init (CallsNewCallBox *self)
 {
@@ -334,6 +343,11 @@ calls_new_call_box_init (CallsNewCallBox *self)
                            G_CALLBACK (origin_count_changed_cb),
                            self,
                            G_CONNECT_SWAPPED);
+  g_signal_connect_swapped (g_application_get_default (),
+                            "main-window-closed",
+                            G_CALLBACK (on_main_window_closed),
+                            self);
+
   origin_count_changed_cb (self);
 }
 
-- 
GitLab

